name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Run tests
        run: npm test

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            coverage/
            !coverage/tmp/
          retention-days: 30

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/coverage-final.json
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true

      - name: Comment coverage summary on PR
        uses: romeovs/lcov-reporter-action@v0.3.1
        if: github.event_name == 'pull_request'
        with:
          lcov-file: ./coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Type check
        run: npm run typecheck

      - name: Build TypeScript
        run: npm run build

      - name: Check build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "Build failed: dist directory not found"
            exit 1
          fi
          if [ ! -f "dist/server.js" ]; then
            echo "Build failed: dist/server.js not found"
            exit 1
          fi
          echo "Build successful: dist/server.js exists"

  salesforce:
    name: Salesforce Validation
    runs-on: ubuntu-latest
    env:
      SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf version

      - name: Authorize Dev Hub
        if: env.SFDX_AUTH_URL != ''
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --set-default-dev-hub --alias DevHub
          rm auth.txt

      - name: Create Scratch Org
        if: env.SFDX_AUTH_URL != ''
        run: |
          sf org create scratch --definition-file config/project-scratch-def.json --alias ciorg --set-default --duration-days 1 --wait 10

      - name: Deploy metadata to Scratch Org
        if: env.SFDX_AUTH_URL != ''
        run: |
          sf project deploy start --source-dir force-app --wait 10

      - name: Run Apex tests with coverage
        if: env.SFDX_AUTH_URL != ''
        run: |
          sf apex run test --test-level RunLocalTests --code-coverage --result-format human --wait 10 > apex-test-results.txt
          cat apex-test-results.txt

      - name: Upload Apex test results
        uses: actions/upload-artifact@v4
        if: always() && env.SFDX_AUTH_URL != ''
        with:
          name: apex-test-results
          path: apex-test-results.txt
          retention-days: 30

      - name: Delete Scratch Org
        if: always() && env.SFDX_AUTH_URL != ''
        run: |
          sf org delete scratch --target-org ciorg --no-prompt

      - name: Skip Salesforce validation (no Dev Hub configured)
        if: env.SFDX_AUTH_URL == ''
        run: |
          echo "⚠️  Salesforce validation skipped: SFDX_AUTH_URL secret not configured"
          echo "To enable Salesforce CI validation:"
          echo "1. Authenticate to your Dev Hub org: sf org login web --set-default-dev-hub --alias DevHub"
          echo "2. Generate auth URL: sf org display --verbose --target-org DevHub"
          echo "3. Add SFDX_AUTH_URL as a GitHub secret with the Sfdx Auth Url value"
