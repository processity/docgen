name: E2E Tests

on:
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true  

jobs:
  create-scratch-org:
    name: Create Scratch Org
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ci
    outputs:
      org_alias: ${{ steps.create-org.outputs.org_alias }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate Dev Hub
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          echo "$SFDX_AUTH_URL" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --alias devhub --set-default-dev-hub
          rm auth.txt

      - name: Create scratch org
        id: create-org
        run: |
          ORG_ALIAS="e2e-test-${{ github.run_number }}"
          echo "org_alias=${ORG_ALIAS}" >> $GITHUB_OUTPUT

          sf org create scratch \
            --definition-file config/project-scratch-def.json \
            --alias ${ORG_ALIAS} \
            --set-default \
            --duration-days 1 \
            --wait 10 \
            --json > org-create.json

          # Check if creation succeeded
          if [ $(jq -r '.status' org-create.json) -eq 0 ]; then
            echo "‚úÖ Scratch org created successfully"
          else
            echo "‚ùå Failed to create scratch org"
            cat org-create.json
            exit 1
          fi

      - name: Deploy Salesforce metadata
        run: |
          sf project deploy start --source-dir force-app --wait 10
          echo "‚úÖ Metadata deployed"

      - name: Configure External Credential with AAD secrets
        id: apex-config
        continue-on-error: true
        env:
          AAD_CLIENT_ID: ${{ secrets.AAD_CLIENT_ID }}
          AAD_CLIENT_SECRET: ${{ secrets.AAD_CLIENT_SECRET }}
        run: |
          echo "Configuring External Credential with AAD client credentials via Apex..."

          # Replace placeholders in template and create temporary Apex script
          sed -e "s|{{CLIENT_ID}}|$AAD_CLIENT_ID|g" \
              -e "s|{{CLIENT_SECRET}}|$AAD_CLIENT_SECRET|g" \
              scripts/ConfigureExternalCredential.apex > /tmp/configure-cred.apex

          # Execute Apex script
          sf apex run --file /tmp/configure-cred.apex

          if [ $? -eq 0 ]; then
            echo "‚úÖ External Credential configured successfully via Apex ConnectApi"
          else
            echo "‚ö†Ô∏è  Apex configuration failed to set credentials"
            exit 1
          fi

      - name: Assign permission set
        run: |
          sf org assign permset --name Docgen_User

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Update Key Vault with scratch org SFDX Auth URL
        run: |
          echo "Extracting SFDX Auth URL from scratch org..."

          SFDX_AUTH_URL=$(sf org display --verbose --json | jq -r '.result.sfdxAuthUrl')

          if [ -z "$SFDX_AUTH_URL" ] || [ "$SFDX_AUTH_URL" = "null" ]; then
            echo "‚ùå Failed to extract SFDX Auth URL from org"
            exit 1
          fi

          echo "‚úÖ Extracted SFDX Auth URL from scratch org"

          # Update Key Vault secret directly
          echo "$SFDX_AUTH_URL" | az keyvault secret set \
            --vault-name docgen-ci-kv \
            --name SFDX-AUTH-URL \
            --value @/dev/stdin \
            --output none

          echo "‚úÖ Updated Key Vault with scratch org SFDX Auth URL"

          # Save SFDX Auth URL to file for e2e-tests job
          echo "$SFDX_AUTH_URL" > sfdx-auth-url.txt

      - name: Upload SFDX Auth URL artifact
        uses: actions/upload-artifact@v4
        with:
          name: sfdx-auth-url
          path: sfdx-auth-url.txt
          retention-days: 1

      - name: Restart Container App to pick up new SFDX Auth URL
        run: |
          echo "üîÑ Restarting Container App to pick up scratch org credentials..."

          # Check if container app exists first
          if az containerapp show --name docgen-ci --resource-group docgen-ci-rg &>/dev/null; then
            az containerapp revision restart \
              --name docgen-ci \
              --resource-group docgen-ci-rg \
              --revision $(az containerapp revision list \
                --name docgen-ci \
                --resource-group docgen-ci-rg \
                --query '[0].name' -o tsv)

            echo "‚úÖ Container App restarted"
            echo "‚è≥ Waiting 30 seconds for secret to propagate..."
            sleep 30
          else
            echo "‚ÑπÔ∏è  Container App doesn't exist yet (will be created by deploy-ci-backend job)"
          fi

  deploy-ci-backend:
    name: Deploy CI Backend
    needs: create-scratch-org
    uses: ./.github/workflows/deploy-ci-backend.yml
    secrets: inherit

  e2e-tests:
    name: Playwright E2E Tests with Real Backend
    runs-on: ubuntu-latest
    needs: [create-scratch-org, deploy-ci-backend]
    timeout-minutes: 30
    environment: ci

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Download SFDX Auth URL artifact
        uses: actions/download-artifact@v4
        with:
          name: sfdx-auth-url

      - name: Authenticate to scratch org
        run: |
          echo "Authenticating to scratch org using SFDX Auth URL..."
          sf org login sfdx-url --sfdx-url-file sfdx-auth-url.txt --alias ${{ needs.create-scratch-org.outputs.org_alias }} --set-default
          rm sfdx-auth-url.txt
          echo "‚úÖ Authenticated to scratch org"

      - name: Get org credentials
        id: org-info
        run: |
          # Get org info
          sf org display --json > org-info.json

          # Extract credentials and set as environment variables
          INSTANCE_URL=$(jq -r '.result.instanceUrl' org-info.json)
          ACCESS_TOKEN=$(jq -r '.result.accessToken' org-info.json)
          USERNAME=$(jq -r '.result.username' org-info.json)

          echo "SF_INSTANCE_URL=$INSTANCE_URL" >> $GITHUB_ENV
          echo "SF_ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
          echo "SF_USERNAME=$USERNAME" >> $GITHUB_ENV

          echo "Instance URL: $INSTANCE_URL"
          echo "Username: $USERNAME"

      - name: Verify CI backend is healthy
        run: |
          BACKEND_URL="${{ needs.deploy-ci-backend.outputs.backend_url }}"
          echo "Verifying CI backend health at: ${BACKEND_URL}/readyz"

          MAX_ATTEMPTS=20
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking ${BACKEND_URL}/readyz"

            # Get HTTP status code
            HTTP_CODE=$(curl -s -o /tmp/readyz-response.json -w "%{http_code}" "${BACKEND_URL}/readyz")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Backend responded with HTTP 200"

              # Verify JSON response shows ready: true
              if jq -e '.ready == true' /tmp/readyz-response.json > /dev/null 2>&1; then
                echo "‚úÖ CI backend is healthy and ready (all dependencies OK)"
                cat /tmp/readyz-response.json | jq '.'
                exit 0
              else
                echo "‚ö†Ô∏è  Backend returned 200 but reports not ready:"
                cat /tmp/readyz-response.json | jq '.'
              fi
            else
              echo "Backend returned HTTP $HTTP_CODE (expected 200)"
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Retrying in 6 seconds..."
              sleep 6
            fi
          done

          echo "‚ùå CI backend failed health check after $MAX_ATTEMPTS attempts (2 minutes)"
          echo "Last response:"
          cat /tmp/readyz-response.json 2>/dev/null || echo "No response captured"
          exit 1

      - name: Run Playwright E2E tests
        run: npm run test:e2e
        env:
          CI: true
          BACKEND_URL: ${{ needs.deploy-ci-backend.outputs.backend_url }}

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: e2e/test-results/
          retention-days: 30

      - name: Delete scratch org
        if: always()
        run: |
          sf org delete scratch \
            --target-org ${{ needs.create-scratch-org.outputs.org_alias }} \
            --no-prompt || echo "Org already deleted or not found"

      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read test results if available
            let testSummary = '## E2E Test Results\n\n';

            try {
              const reportPath = 'e2e/playwright-report/index.html';
              if (fs.existsSync(reportPath)) {
                testSummary += '‚úÖ Tests completed. View the [Playwright Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n';
              } else {
                testSummary += '‚ö†Ô∏è Test report not found.\n';
              }
            } catch (error) {
              testSummary += '‚ùå Failed to read test results.\n';
            }

            // Comment on PR
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: testSummary
            });
